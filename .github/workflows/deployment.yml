name: "ðŸ§—â€â™€ï¸ Deploy Docling Helm Chart"

on:
  workflow_dispatch:
    paths-ignore:
      - '.github/**'
      - '**.md' 


permissions: # https://graphite.com/guides/github-actions-permissions
  contents: read

concurrency: # https://docs.github.com/en/actions/how-tos/write-workflows/choose-when-workflows-run/control-workflow-concurrency
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: docling
  NAMESPACE: docling

jobs:
  setup-and-helming:
    runs-on: ubuntu-latest
    steps:
    
      - name: ðŸ’¾ Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd #v5.0.1

      - name: âš™ï¸ Setup kubectl
        uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede #v4.0.1
        with:
          version: v1.33.0

      - name: âš™ï¸ Setup helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 #v4.3.1
        with:
          version: '3.11.3'      

      - name: âš™ï¸ Configure kubeconfig
        run: |
          mkdir -p "${HOME}/.kube"
          printf "%s" "${KUBECONFIG}" > "${HOME}/.kube/config"
          chmod 600 "${HOME}/.kube/config"
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: âœ… Verify cluster connectivity
        run: kubectl cluster-info

      - name: ðŸ”¨ Helming ...
        run: |
          helm upgrade --install ${{ env.APP_NAME }} . \ 
          --namespace ${{ env.NAMESPACE }} --create-namespace \
          --atomic \
          --wait \
          --timeout 5m \